---
title: "Final Project"
author: "Iman Byndloss, Brock Keller, and Rachel Williams"
date: "2025-02-12"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(dplyr)
library(tidyverse)
library(moments)
library(ggplot2)
library(lubridate)
library(readxl)
library(FSA)
library(lme4)
library(lmerTest)
library(dunn.test)
```


```{r}
#NC air data from EPA
Air_Data_NC <- read.csv("NC_Air_Data_Project.csv")
```

##Data preparation and exploratory analysis

```{r}
#making a plot for first assignment
#annual range in concentrations of select chemical in each site
unique(Air_Data_NC$SITE_ID)
#setting concentrations to be numeric

Air_Data_NC <- Air_Data_NC %>% 
  mutate(across(c(Week, Year, Ca, Cl, HNO3, HNO3.PPB, K, Mg, Na, NH4, NO3, SO2, SO2.PPB, SO4, TNO3,), as.numeric))

#Changing SITE_ID to name of actual town
Air_Data_NC <- Air_Data_NC %>% 
  mutate(SITE_ID = case_when(
    SITE_ID == "BFT142" ~ "Beaufort",
    SITE_ID == "CND125" ~ "Candor",
    SITE_ID == "COW137" ~ "Coweeta",
    SITE_ID == "DUK008" ~ "Duke Forest",
    SITE_ID == "PNF126" ~ "Cranberry"
  ))


#filtering for just 2022
Air_Data_2022 <- Air_Data_NC %>% 
  filter(Year == "2022")

#checking how variables are stored. Looks good
str(Air_Data_2022$SO4)


#grouping by SITE_ID and getting summary statistics
Air_Summary_2022_SO4 <- Air_Data_2022 %>% 
  group_by(SITE_ID) %>% 
  summarize(mean = mean(SO4, na.rm = TRUE),
            sd = sd(SO4, na.rm = TRUE)) %>% 
  ungroup()

#making plot
jpeg(filename = "ByndlossIKellerBWilliamsRFig1.jpeg", 
     width = 2400, height = 1800, res = 300)

SO4_2022_plot <- ggplot()+
  geom_errorbar(data = Air_Summary_2022_SO4, na.rm = TRUE,
                aes(x = SITE_ID, 
                    ymin = mean - sd,
                    ymax = mean + sd,
                    color = SITE_ID),
                width = 0.1, size = 1)+
  geom_jitter(data = Air_Data_2022, na.rm = TRUE,
              aes(x = SITE_ID, y = SO4, 
                  color = SITE_ID),
              alpha = 0.8, size = 0.5)+
  geom_point(data = Air_Summary_2022_SO4, na.rm = TRUE,
             aes(x = SITE_ID, y = mean,
                 color = SITE_ID),
             SIZE = 3)+
  labs(title = "Concentrations of SO4 by Site in 2022",
       x = "Site",
       y = "Weekly Mean SO4 Concentration (ug/m^3)",
       caption = "Figure 1: Figure showing mean weekly SO4 air concentration \n in 2022 across five EPA air monitoring sites in North Carolina.")+
  theme_bw()+ 
  theme(plot.caption = 
      element_text(hjust =  0.5, size = 10))

print(SO4_2022_plot)

dev.off()
```

##Multilevel Regression

```{r}

#Add season collumn, maybe use multilevel model.

#1/Site generates random variable, don't need to specify site

Air_Data_NC$Season <- ifelse(Air_Data_NC$Week %in% c(25:34), "SUMMER",
                    ifelse (Air_Data_NC$Week %in% c(35:51), "AUTUMN",ifelse (Air_Data_NC$Week %in% c(52, 53, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11), 
                                    "WINTER", "SPRING")))

Air_Data_NC$Season <- factor(Air_Data_NC$Season,
                             levels=( c("SUMMER", "AUTUMN", "WINTER", "SPRING")))

Air_Data_NC$SITE_ID <- factor(Air_Data_NC$SITE_ID,
                              levels=(c("Beaufort", "Candor", "Coweeta","Cranberry","Duke Forest")))

#lmer (concentration ~ Season + Year + 1|SITE_ID,
#      data=df)

lmtest <- lm(SO4 ~ Season + Year, data=Air_Data_NC)
summary(lmtest)
plot(lmtest)

ggplot(Air_Data_NC) +
  geom_boxplot(aes(x=SITE_ID, y=SO4)) +
  geom_jitter(aes(x=SITE_ID, y=SO4))


lmm1 <- lmer(SO4 ~ Season + Year + (1|SITE_ID), data=Air_Data_NC)
AIC(lmm1) #Only gas with normal AIC
plot(lmm1)
qqnorm(resid(lmm1)) 
summary(lmm1) #Lower in Winter and Autumn than in summer. Decreasing over time in the target years. 

lmm2 <- lmer(NO3 ~ Season + Year + (1|SITE_ID), data=Air_Data_NC)
AIC(lmm2)
plot(lmm2)
qqnorm(resid(lmm2)) 
summary(lmm2)#Autumn, winter, and spring all have significantly higher concentrations than in summer. 

lmm3 <- lmer(HNO3 ~ Season + Year + (1|SITE_ID), data=Air_Data_NC)
AIC(lmm3)
plot(lmm3)
qqnorm(resid(lmm3)) 
summary(lmm3) #Shows concentrations are significantly higher in winter and spring than summer

lmm4 <- lmer(NH4 ~ Season + Year + (1|SITE_ID), data=Air_Data_NC)
AIC(lmm4)
plot(lmm4)
qqnorm(resid(lmm4)) 
summary(lmm4) #Autumn has strong significance, lower concentrations from Summer. It has also been getting lower over the target years. 

#Can say which gases have seasonal effects

```

##Linear Regression

```{r}
#Brock's linear regression work

#I want to use week as a proxy for time of year as a predictor of air concentration of whatever gas. I want to convert the week value (1-52) into a sin and cosine wave transformation so that it fits for seasonality and is not treated as a linear variable which would not make sense here (week 52 is close to week 1 and summer is in the middle). 

#Will do like Y = B0 + B1 sin(2pi*week / 52) + B2 cos(2pi*week / 52) + B3 + B4 + E. Thinking to use concentration of another gas as another predictor and also maybe site ID as a factor, though that might be overfitting. 

Air_Data_NC <- Air_Data_NC %>% 
  mutate(
    sin_week = sin(2 * pi * Week / 52),
    cos_week = cos(2 * pi * Week / 52)
  )

ggplot(Air_Data_NC, aes(x = Week)) +
  geom_line(aes(y = sin_week, color = "Sine"), size = 1) +
  geom_line(aes(y = cos_week, color = "Cosine"), size = 1) 




```


# Boxplots
```{r}
Air_Data_NC$Date <- as.Date(paste(Air_Data_NC$Year, 
                                  Air_Data_NC$Week, 
                                  1, sep = "-"), 
                            format = "%Y-%U-%u")

NC_pollutants <- Air_Data_NC %>%
  select(Date, SITE_ID, HNO3, NH4, NO3, SO4)

NC_pollutants_long <- NC_pollutants %>%
  pivot_longer(cols = -c(Date, SITE_ID), 
               names_to = "Pollutant", 
               values_to = "Value")

# Create faceted boxplots
ggplot(NC_pollutants_long, aes(x = SITE_ID, y = Value)) +
  geom_boxplot() +
  theme_minimal() +
  facet_wrap(~ Pollutant, scales = "free_y") +
  labs(title = "Pollutant Levels by Site",
       x = "Site ID", y = "Value") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


# Spatail Analysis

Before conducting an ANOVA, it is important to check if the data meets the necessary assumptions: 1) normally distributed samples values, 2) samples are independent of one another, and 3) population variances are equal.

```{r}
# Checking for normality through histograms of pollutants by site id
hist1 <- ggplot(NC_pollutants, aes(x = HNO3,
                                   fill = SITE_ID)) +
  geom_histogram() + #set number of bins according to rice rule????
  labs(x = "HNO3",
       y = "Count",
       title = "Distribution of Ca value by Site ID",
       caption = "Figure 1: This histogram displays the counts for HNO3 ?????? 
       across five site ids in North Carolina.") +
  facet_grid(.~SITE_ID) +
  theme_bw() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5))
hist1
hist2 <- ggplot(NC_pollutants, aes(x = NH4,
                                   fill = SITE_ID)) +
  geom_histogram() + #set number of bins according to rice rule????
  labs(x = "NH4",
       y = "Count",
       title = "Distribution of NH4 value by Site ID",
       caption = "Figure 1: This histogram displays the counts for NH4 ?????? 
       across five site ids in North Carolina.") +
  facet_grid(.~SITE_ID) +
  theme_bw() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5))
hist2
hist3 <- ggplot(NC_pollutants, aes(x = NO3,
                                   fill = SITE_ID)) +
  geom_histogram() + #set number of bins according to rice rule????
  labs(x = "NO3",
       y = "Count",
       title = "Distribution of NO3 value by Site ID",
       caption = "Figure 1: This histogram displays the counts for NO3 ?????? 
       across five site ids in North Carolina.") +
  facet_grid(.~SITE_ID) +
  theme_bw() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5))
hist3
hist4 <- ggplot(NC_pollutants, aes(x = SO4,
                                   fill = SITE_ID)) +
  geom_histogram() + #set number of bins according to rice rule????
  labs(x = "SO4",
       y = "Count",
       title = "Distribution of SO4 value by Site ID",
       caption = "Figure 1: This histogram displays the counts for SO4 ?????? 
       across five site ids in North Carolina.") +
  facet_grid(.~SITE_ID) +
  theme_bw() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5))
hist4

# Since NO3 non-normally distributed, applying log10 to NO3
NC_pollutants <- NC_pollutants %>%
  mutate(log_NO3 = log10(NO3))

# Creating another histogram with log transformed NO3
hist5 <- ggplot(NC_pollutants, aes(x = log_NO3,
                                   fill = SITE_ID)) +
  geom_histogram() + #set number of bins according to rice rule????
  labs(x = "log transformed NO3",
       y = "Count",
       title = "Distribution of Log-Transformed NO3 value by Site ID",
       caption = "Figure 1: This histogram displays the counts for 
       log-transformed NO3 ?????? 
       across five site ids in North Carolina.") +
  facet_grid(.~SITE_ID) +
  theme_bw() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5))
hist5
```

Based on the histograms, the pollutants are all normally distributed, but it important to note that NO3 had to be log-transformed to meet this assumption.

```{r}
# Conducting Bartlett test for homogeneity
variance_HNO3 <- bartlett.test(NC_pollutants$HNO3,
                               NC_pollutants$SITE_ID)
variance_HNO3
variance_NH4 <- bartlett.test(NC_pollutants$NH4,
                               NC_pollutants$SITE_ID)
variance_NH4
variance_NO3 <- bartlett.test(NC_pollutants$NO3,
                               NC_pollutants$SITE_ID)
variance_NO3
variance_SO4 <- bartlett.test(NC_pollutants$SO4,
                               NC_pollutants$SITE_ID)
variance_SO4
```

Although NO3 could be log-transformed to become more normally distributed, none of the pollutants passed the Barlett test for homogeneity of variances.

```{r}
# Calculating variances of pollutants by site
variance_check_HNO3 <- NC_pollutants %>%
  group_by(SITE_ID) %>%
  summarise(Variance = var(HNO3, na.rm = TRUE))

variance_check_NH4 <- NC_pollutants %>%
  group_by(SITE_ID) %>%
  summarise(Variance = var(NH4, na.rm = TRUE))

variance_check_NO3 <- NC_pollutants %>%
  group_by(SITE_ID) %>%
  summarise(Variance = var(NO3, na.rm = TRUE))

variance_check_SO4 <- NC_pollutants %>%
  group_by(SITE_ID) %>%
  summarise(Variance = var(SO4, na.rm = TRUE))

# Calculating max, min, and max/min for variance 
max_variance_HNO3 <- max(variance_check_HNO3$Variance)
min_variance_HNO3 <- min(variance_check_HNO3$Variance)
variance_ratio_HNO3 <- max_variance_HNO3 / min_variance_HNO3
variance_ratio_HNO3

max_variance_NH4 <- max(variance_check_NH4$Variance)
min_variance_NH4 <- min(variance_check_NH4$Variance)
variance_ratio_NH4 <- max_variance_NH4 / min_variance_NH4
variance_ratio_NH4

max_variance_NO3 <- max(variance_check_NO3$Variance)
min_variance_NO3 <- min(variance_check_NO3$Variance)
variance_ratio_NO3 <- max_variance_NO3 / min_variance_NO3
variance_ratio_NO3

max_variance_SO4 <- max(variance_check_SO4$Variance)
min_variance_SO4 <- min(variance_check_SO4$Variance)
variance_ratio_SO4 <- max_variance_SO4 / min_variance_SO4
variance_ratio_SO4
```

To conduct another test of variance, we calculated the maximum-minimum ratio for variance. If the ratio is less than 4, than equal variances can be assumed. Only two of the four pollutants (SO4 and NH4) passed this test. Due to these results, we could perform a one-way ANOVA for those two pollutants, but we will instead run the non-parametric alternative to a one-way ANOVA, i.e., a Kruskal Wallis test, for all pollutants.

```{r}
# Running Kruskal Wallis + Dunn 
kw_HO3 <- kruskal.test(HNO3 ~ SITE_ID, data = NC_pollutants)
kw_HO3
dunn_HO3 <- dunn.test(NC_pollutants$HNO3, NC_pollutants$SITE_ID, 
                      kw = TRUE, label = TRUE, wrap = TRUE)
dunn_HO3

kw_NH4 <- kruskal.test(NH4 ~ SITE_ID, data = NC_pollutants)
kw_NH4
dunn_NH4 <- dunn.test(NC_pollutants$NH4, NC_pollutants$SITE_ID, 
                      kw = TRUE, label = TRUE, wrap = TRUE)
dunn_NH4

kw_NO3 <- kruskal.test(NO3 ~ SITE_ID, data = NC_pollutants)
kw_NO3
dunn_NO3 <- dunn.test(NC_pollutants$NO3, NC_pollutants$SITE_ID, 
                      kw = TRUE, label = TRUE, wrap = TRUE)
dunn_NO3

kw_SO4 <- kruskal.test(SO4 ~ SITE_ID, data = NC_pollutants)
kw_SO4
dunn_SO4 <- dunn.test(NC_pollutants$SO4, NC_pollutants$SITE_ID, 
                      kw = TRUE, label = TRUE, wrap = TRUE)
dunn_SO4
```






